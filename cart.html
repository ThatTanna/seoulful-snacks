<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="css/cart.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Outfit:wght@100..900&family=Overpass:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <!-- Header Component -->
    <script src="components/header.js" type="text/javascript" defer></script>
    <script src="components/footer.js" type="text/javascript" defer></script>
</head>

<body>
    <header-component></header-component>
    <main class="m-3">
        <h1>MY CART</h1>
        <section class="m-3 p-3">
            <div class="cart-cards">
                <!-- @For Loop cards for cart items -->
                <div class="mx-auto card mb-3" style="max-width: 640px;">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <!-- TODO: Cart Image Goes Here -->
                            <img id="card-image" src="images/cart/no-image.png"
                                class="border border-5 border-danger-subtle rounded img-fluid rounded-start"
                                alt="real-pizza-bagel-chip">
                        </div>
                        <div class="col-md-8">
                            <div class="card-body row">
                                
                                <h5 id="card-title" class="card-title col-md-10 p-2"> 
                                    <!-- TODO: Cart Title Goes Here -->
                                </h5>

                                <button type="button" class="btn bi bi-trash col-md-2" id="btnClearCart"></button>
                                <p id="card-description" class="card-text">
                                    <!-- TODO: Cart Desc Goes Here -->
                                </p>
                                <div class="row">
                                    <div class="btn-group col-md-5" role="group" aria-label="Basic example">
                                        <button type="button" class="border btn bi bi-dash-circle" id="btnMinus">
                                        </button>
                                        <button type="button" class="border btn" id="btnQuantity">
                                            <!-- TODO: Quantity Goes Here -->
                                        </button>
                                        <button type="button" class="border btn bi bi-plus-circle" id="btnPlus">
                                        </button>
                                    </div>
                                    <div id="card-price" class="col-md-7 m-auto">
                                        <!-- TODO: Cart Price Goes Here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <article>
            <div class="checkout text-center">
                <button id="btnCheckout" type="button" class="checkout-button btn  bi bi-cart-fill">
                    Continue to checkout
                </button>
            </div>
        </article>
    </main>
    <footer-component></footer-component>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="components/auth.js"></script>
    <script src="components/cart.js"></script>
    <script>

        // TODO: get the athenication token (DONE)
        const authenticated = auth();

        // TODO: manage the quantity on the cart page
        let productQuantity = 0;
        let cartPrice = 0;
        const btnQty = document.getElementById("btnQuantity");

        // get the urlParam for package
        let urlParams = new URLSearchParams(window.location.search);
        let package = urlParams.get("package");
        let quantity = urlParams.get("qty");

        // TODO: set btnQuantity a default value of 1
        document.addEventListener("DOMContentLoaded", () => {
            
            if(quantity){
                productQuantity = Number(quantity);
            }
            else
            {
                productQuantity = 1;
            }                

            btnQty.innerText = productQuantity;

            // hide the checkout button if no package is selected
            if(!package){
                const btnChkout = document.getElementById("btnCheckout");
                btnChkout.style.display = "none";
            }
        })

        // TODO: display the cart results (DONE)
        const cartResult = async ()=>{

            if(!package){
                // Inform the user that no product has been found
                document.getElementById("card-title").innerText = "No product found.";
                document.getElementById("card-description").innerText = "Please subscribe to a product.";
                document.getElementById("card-price").innerText = "$0.00";
                return;
            }

            const cartItem =await getCart(authenticated, package);
            
            // Product Title
            let cartTitle = cartItem.name;
            cartTitle = cartTitle.charAt(0).toUpperCase() + cartTitle.slice(1);
            document.getElementById("card-title").innerText = cartTitle;

            // Product Description
            let cartDesc = cartItem.description;
            cartDesc = cartDesc.charAt(0).toUpperCase() + cartDesc.slice(1);
            document.getElementById("card-description").innerText = cartDesc;

            // Product Price
            cartPrice = cartItem.price;
            let quantityPrice = 0;
            
            if(quantity){
                quantityPrice = cartPrice * productQuantity;
                quantityPrice = (Math.round(quantityPrice * 100) / 100).toFixed(2);
                document.getElementById("card-price").innerText = `$${quantityPrice}`;
            }else{
                cartPrice = (Math.round(cartPrice * 100) / 100).toFixed(2);
                document.getElementById("card-price").innerText = `$${cartPrice}`;
            }
            
            if(package){
                // Product Image
                let cartImage = cartItem.imagePath;
                document.getElementById("card-image").setAttribute("style", "background-color:red;");
                document.getElementById("card-image").setAttribute("src", "http://localhost:8080" + cartImage);
            }


            return;
        };

        cartResult();

        // TODO: btnPlus adds one more item to the cart
        document.getElementById("btnPlus").addEventListener("click",(event) => {
            productQuantity += 1;
            btnQty.innerText = productQuantity;
            cartPrice = (Math.round(cartPrice * 100) / 100).toFixed(2);
            let totalPrice = cartPrice * productQuantity;
            totalPrice = (Math.round(totalPrice * 100) / 100).toFixed(2);
            document.getElementById("card-price").innerText = `$${totalPrice}`;
        })

        // TODO: btnMinus removes one item from the cart
        document.getElementById("btnMinus").addEventListener("click",(event) => {
            if(productQuantity >= 2)
                productQuantity -= 1;
            btnQty.innerText = productQuantity;
            cartPrice = (Math.round(cartPrice * 100) / 100).toFixed(2);
            let totalPrice = cartPrice * productQuantity;
            totalPrice = (Math.round(totalPrice * 100) / 100).toFixed(2);
            document.getElementById("card-price").innerText = `$${totalPrice}`;
        })

        // TODO: btnCheckout goes to the checkout page with the quantity (DONE)
        document.getElementById("btnCheckout").addEventListener("click",(event) => {
            event.preventDefault();
            event.stopPropagation();

            let url = window.location.origin;
            url += "/checkout.html";

            if(!package){
                return;
            }
            
            url += `?package=${package}&qty=${productQuantity}`;
            window.location = url;
            return;
        })

        document.getElementById("btnClearCart").addEventListener("click", (event) => {
            event.preventDefault();
            event.stopPropagation();

            let url = window.location.origin;
            url += "/products.html";
            window.location = url;
        })

    </script>
</body>

</html>