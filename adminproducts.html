<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="css/admin.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Outfit:wght@100..900&family=Overpass:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <!-- Header + Footer Components -->
    <script src="components/adminheader.js" type="text/javascript" defer></script>
    <script src="components/footer.js" type="text/javascript" defer></script>
</head>
<body>
    <!-- Navbar -->
    <header-component></header-component>
    <!-- Form Container -->
    <div class="container-lg">
        <div class="admin-title my-2">
            <h1>Add Product</h1>
        </div>
        <div class="productinputs p-5">
            <form id="uploadForm">
                <div class="addproduct">
                    <label>Product Name:</label>
                    <input type="text" id="txtName" placeholder="E.g. K-Pop Party Pack"> <br>
                    <label>Description:</label>
                    <textarea id="txtDesc" rows="6" placeholder="Enter description here."></textarea> <br>
                    <label>Price:</label>
                    <input type="text" id="txtPrice" placeholder="0.00">
                    <div class="form-group pt-2">
                        <label for="photoInput">Upload Photo Here:</label>
                        <input type="file" class="form-control-file" id="file" name="photo"><br><br>
                    </div>
                    <!-- Upload & Reset Buttons -->
                    <button type="button" class="btn" id="liveToastBtn">Upload</button>
                    <button type="reset" class="btn">Reset</button>

                    <!-- successful upload button toast -->
                    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                          <strong class="me-auto">Uploaded</strong>
                          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                          Product Added Successfully!
                        </div>
                      </div>

                    <script>
                        // Display result on click
                        const toastTrigger = document.getElementById('liveToastBtn')
                        const toastLiveExample = document.getElementById('liveToast')
                        if (toastTrigger) {
                             const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
                             toastTrigger.addEventListener('click', () => {
                             toastBootstrap.show()
                             })
                            }
                    </script>
                </div>
            </form>
        </div>

        <div class="admin-title my-2">
            <h1>Our Products</h1>
        </div>

        <!-- Product Container -->
        <div class="container-fluid card rounded-5">

            <section id="product-cards-container" class="flex-row w-100">
                <!-- product cards go here. -->
            </section>

            <!-- Modal for Edit goes here -->
            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="editModalLabel">Edit Product</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="udpateForm">
                                <label>Product Name:</label>
                                <input id="modalProductName" type="text"> <br>
                                <label>Description:</label>
                                <textarea id="modalProductDesc" rows="6"></textarea> <br>
                                <label>Price:</label>
                                <input id="modalProductPrice" type="text"> <br>
                                <div class="form-group pt-2">
                                    <label for="photoInput">Upload Photo Here:</label>
                                    <input id="modalFile" type="file" class="form-control-file" id="photoInput" name="photo">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button id="btnUpdateProduct" type="button" class="btn btn-primary">Update</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal for Delete goes here -->
            <div class="modal" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Delete Product</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p>You are about to delete product.</p>
                    </div>
                    <div class="modal-footer">
                        <button id="btnDeleteProduct" type="button" class="btn btn-primary">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
            </div>

        </div>
        <script src="components/adminauth.js"></script>
        <script src="components/adminproducts.js"></script>
        <script>
            // TODO: Only authenicated AMIN users can save product information (DONE)
            const authenticated  = adminauth();

            // TODO: eventListener to submit the product information
            document.getElementById('uploadForm').addEventListener('submit', async(event) => {
                
                // Prevent default form submission
                event.preventDefault(); 

                const name = document.getElementById('txtName').value;
                const description = document.getElementById('txtDesc').value;
                const price = document.getElementById('txtPrice').value;
                const file = document.getElementById('file').files[0];

                // Create a JSON object for the product information
                let data = {
                    name: name,
                    description: description,
                    price: price
                };

                // Send authentication and product information to saveProduct
                const result = await saveProduct(authenticated, data, file);

                // Check the success or failure of saving the object
                const messageSuccessAdded = "Product added successfully.";
                const messageFailedAdded = "Product could not be added.";
                
                if(result){
                    alert(messageSuccessAdded);
                    // the products section
                    productResult();
                }
                else
                    alert(messageFailedAdded);

                document.getElementById("uploadForm").reset();
                return;
            });

            // TODO: display the products results (DONE)
            const productResult = async ()=>{

                const productItems =await getAdminProducts();
                const productCardsContainer = document.getElementById("product-cards-container");

                // Clear the container first before populating the products
                while (productCardsContainer.hasChildNodes()) {
                    productCardsContainer.removeChild(productCardsContainer.firstChild);
                }

                productItems.forEach(item => {
                addProductCard(productCardsContainer, item);
                });
            
            };

            productResult();  

            // TODO: tracks if the modal Pops up to retrieve the selected product (DONE)
            const handleIntersection = (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {

                        // if the target is the edit 
                        if(entry.target.id === "editModal"){
                            const editId = window.location.href.match(/edit=([^&]*)/);
                            // get the product selected and populate the input fields
                            const product = getAdminProduct(authenticated, editId[1]);
                            
                            // populate the fields
                            product.then((data) => {
                                document.getElementById("modalProductName").value = data["name"];
                                document.getElementById("modalProductDesc").value = data["description"];
                                document.getElementById("modalProductPrice").value = (Math.round(data["price"] * 100) / 100).toFixed(2);
                            })
                        }

                    }
                });
            };

            // create a new Intersection Observer instance
            const observer = new IntersectionObserver(handleIntersection);

            // set the target element to observe
            const targetElementEdit = document.getElementById("editModal");
            const targetElementDelete = document.getElementById("deleteModal");

            // start observing the target element
            observer.observe(targetElementEdit);
            observer.observe(targetElementDelete);

            // TODO: Update the product when the user selects btnUdpateProduct
            document.getElementById("btnUpdateProduct").addEventListener("click", async(event) => {
                event.preventDefault();
                event.stopPropagation();

                const modalName = document.getElementById("modalProductName").value;
                const modalDesc = document.getElementById("modalProductDesc").value;
                const modalPrice = document.getElementById("modalProductPrice").value;
                const modalFile = document.getElementById('modalFile').files[0];
                
                // Create a JSON object for the product information
                let modalData = {
                    name: modalName,
                    description: modalDesc,
                    price: modalPrice
                };

                // get the product selected via the url #tag
                const editId = window.location.href.match(/edit=([^&]*)/);

                // Send authentication and product information to saveProduct
                const result = await saveUpdatedProduct(authenticated, editId[1], modalData, modalFile);
                
                // Check the success or failure of saving the object
                const messageSuccessEdited = "Product updated successfully.";
                const messageFailedEdited = "Product could not be updated.";

                if(result){

                    // hide the modal that updates the product
                    let modalElement = document.getElementById("editModal");
                    let updateModal = bootstrap.Modal.getInstance(modalElement);
                    updateModal.hide();

                    // show the success message
                    alert(messageSuccessEdited);

                    // invoke productResults to re-list the products section (DONE)
                    productResult();
                }
                else{
                    alert(messageFailedEdited);
                }
                
                return;

            })

            // TODO: Update the product when the user selects btnUdpateProduct
            document.getElementById("btnDeleteProduct").addEventListener("click", async(event) => {
                event.preventDefault();
                event.stopPropagation();

                const deleteId = window.location.href.match(/delete=([^&]*)/);
                // get the product selected and populate the input fields
                const result = await deleteProduct(authenticated, deleteId[1]);

                // Check the success or failure of saving the object
                const messageSuccessDeleted = "Product deleted successfully.";
                const messageFailedDeleted = "Product could not be deleted.";

                if(result){

                    // hide the modal that updates the product
                    let modalElement = document.getElementById("deleteModal");
                    let deleteModal = bootstrap.Modal.getInstance(modalElement);
                    deleteModal.hide();

                    // show the success message
                    alert(messageSuccessDeleted);

                    // invoke productResults to re-list the products section (DONE)
                    productResult();
                }
                else{
                    alert(messageFailedDeleted);
                }
                

                // invoke productResults to re-list the products section (DONE)
                productResult();
            })
        </script>
    </div>
    <!-- Footer -->
    <footer-component></footer-component>
    <!-- Footer -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>
</html> 